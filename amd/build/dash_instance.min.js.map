{"version":3,"sources":["../src/dash_instance.js"],"names":["define","$","Log","Ajax","Notification","ModalEvents","PreferencesModal","DashInstance","root","blockInstanceId","blockContextid","editing","currentPage","blockPreferencesModal","sortField","sortDirections","init","prototype","BLOCK_CONTENT_SELECTOR","FILTER_FORM_SELECTOR","debug","initDatePickers","initSelect2","getRoot","find","refresh","bind","on","e","preventDefault","target","serializeArray","getBlockContentArea","data","$target","hasOwnProperty","getFilterForm","getBlockContent","sortDirection","request","methodname","args","block_instance_id","filter_form_data","JSON","stringify","page","sort_field","sort_direction","call","css","then","response","html","catch","exception","datepicker2","autoclose","format","each","index","element","placeholder","id","text","select2","dropdownParent","allowClear","theme","removeData"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'core/notification', 'core/modal_events',\r\n    'block_dash/preferences_modal', 'block_dash/datepicker', 'block_dash/select2'],\r\n    function($, Log, Ajax, Notification, ModalEvents, PreferencesModal) {\r\n\r\n        var DashInstance = function(root, blockInstanceId, blockContextid, editing) {\r\n            this.root = $(root);\r\n            this.blockInstanceId = blockInstanceId;\r\n            this.blockContextid = blockContextid;\r\n            this.currentPage = 0;\r\n            this.blockPreferencesModal = null;\r\n            this.editing = editing;\r\n            this.sortField = null;\r\n            this.sortDirections = {};\r\n\r\n            this.init();\r\n        };\r\n\r\n        DashInstance.prototype.BLOCK_CONTENT_SELECTOR = '.dash-block-content';\r\n        DashInstance.prototype.FILTER_FORM_SELECTOR = '.filter-form';\r\n\r\n        DashInstance.prototype.init = function() {\r\n            Log.debug('Initializing dash instance', this);\r\n\r\n            this.initDatePickers();\r\n            this.initSelect2();\r\n\r\n            if (this.editing) {\r\n                this.blockPreferencesModal = new PreferencesModal(this.getRoot().find('.dash-edit-preferences'),\r\n                    this.blockContextid, function () {\r\n                        // Preferences changed, go back to first page.\r\n                        this.currentPage = 0;\r\n                        this.refresh();\r\n                    }.bind(this));\r\n            }\r\n\r\n            this.getRoot().on('change', 'select, input', function (e) {\r\n                e.preventDefault();\r\n\r\n                Log.debug('Submitting filter form');\r\n                Log.debug(e);\r\n                Log.debug($(e.target).serializeArray());\r\n\r\n                // Filter results, go back to first page.\r\n                this.currentPage = 0;\r\n                this.refresh();\r\n            }.bind(this));\r\n\r\n            this.getBlockContentArea().on('click', '.page-link', function(e) {\r\n                e.preventDefault();\r\n                this.currentPage = $(e.target).data('page');\r\n                this.refresh();\r\n            }.bind(this));\r\n\r\n            this.getBlockContentArea().on('click', '.dash-sort', function(e) {\r\n                const $target = $(e.target);\r\n                this.sortField = $target.data('sort');\r\n\r\n                // Set sorting to asc by default.\r\n                if (!this.sortDirections.hasOwnProperty(this.sortField)) {\r\n                    this.sortDirections[this.sortField] = 'asc';\r\n                } else {\r\n                    // Toggle sort direction on field.\r\n                    this.sortDirections[this.sortField] = this.sortDirections[this.sortField] === 'asc' ? 'desc' : 'asc';\r\n                }\r\n                this.refresh();\r\n            }.bind(this));\r\n        };\r\n\r\n        /**\r\n         * Get the root element of this dash instance.\r\n         *\r\n         * @method getRoot\r\n         * @return {object} jQuery object\r\n         */\r\n        DashInstance.prototype.getRoot = function() {\r\n            return this.root;\r\n        };\r\n\r\n        /**\r\n         * Get the content element of this dash instance.\r\n         *\r\n         * @method getRoot\r\n         * @return {object} jQuery object\r\n         */\r\n        DashInstance.prototype.getBlockContentArea = function() {\r\n            return this.getRoot().find(this.BLOCK_CONTENT_SELECTOR);\r\n        };\r\n\r\n        /**\r\n         * Get filter form element.\r\n         *\r\n         * @returns {object} jQuery object\r\n         */\r\n        DashInstance.prototype.getFilterForm = function() {\r\n            return this.getRoot().find(this.FILTER_FORM_SELECTOR);\r\n        };\r\n\r\n        DashInstance.prototype.getBlockContent = function() {\r\n            let sortDirection = null;\r\n            if (this.sortField && this.sortDirections.hasOwnProperty(this.sortField)) {\r\n                sortDirection = this.sortDirections[this.sortField];\r\n            }\r\n\r\n            var request = {\r\n                methodname: 'block_dash_get_block_content',\r\n                args: {\r\n                    block_instance_id: this.blockInstanceId,\r\n                    filter_form_data: JSON.stringify(this.getFilterForm().serializeArray()),\r\n                    page: this.currentPage,\r\n                    sort_field: this.sortField,\r\n                    sort_direction: sortDirection\r\n                }\r\n            };\r\n\r\n            return Ajax.call([request])[0];\r\n        };\r\n\r\n        DashInstance.prototype.refresh = function() {\r\n            this.getBlockContentArea().css('opacity', 0.5);\r\n            this.getBlockContent()\r\n                .then(function(response) {\r\n                    this.getBlockContentArea().html(response.html);\r\n                    this.getBlockContentArea().css('opacity', 1);\r\n                    this.initDatePickers();\r\n                    this.initSelect2();\r\n                }.bind(this))\r\n                .catch(Notification.exception);\r\n        };\r\n\r\n        DashInstance.prototype.initDatePickers = function() {\r\n            this.getRoot().find('.datepicker').datepicker2({\r\n                autoclose: true,\r\n                format: \"dd/mm/yyyy\"\r\n            });\r\n        };\r\n\r\n        DashInstance.prototype.initSelect2 = function() {\r\n            this.getRoot().find('.select2').each(function(index, element) {\r\n                let placeholder = null;\r\n                if ($(element).find(\"option[value='-1']\")) {\r\n                    placeholder = {\r\n                        id: '-1', // the value of the option\r\n                        text: $(element).find(\"option[value='-1']\").text()\r\n                    };\r\n                }\r\n                $(element).select2({\r\n                    dropdownParent: this.getRoot(),\r\n                    allowClear: true,\r\n                    theme: 'bootstrap4',\r\n                    placeholder: placeholder\r\n                }).on('select2:unselecting', function() {\r\n                    $(this).data('unselecting', true);\r\n                }).on('select2:opening', function(e) {\r\n                    if ($(this).data('unselecting')) {\r\n                        $(this).removeData('unselecting');\r\n                        e.preventDefault();\r\n                    }\r\n                });\r\n            }.bind(this));\r\n        };\r\n\r\n        return DashInstance;\r\n    });"],"file":"dash_instance.min.js"}