{"version":3,"file":"dash_instance.min.js","sources":["../src/dash_instance.js"],"sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'core/notification', 'core/modal_events',\n    'block_dash/preferences_modal', 'block_dash/datepicker', 'block_dash/select2'],\n    function($, Log, Ajax, Notification, ModalEvents, PreferencesModal) {\n\n        var DashInstance = function(root, blockInstanceId, blockContextid, editing) {\n            this.root = $(root);\n            this.blockInstanceId = blockInstanceId;\n            this.blockContextid = blockContextid;\n            this.currentPage = 0;\n            this.blockPreferencesModal = null;\n            this.editing = editing;\n            this.sortField = null;\n            this.sortDirections = {};\n\n            this.init();\n        };\n\n        DashInstance.prototype.BLOCK_CONTENT_SELECTOR = '.dash-block-content';\n        DashInstance.prototype.FILTER_FORM_SELECTOR = '.filter-form';\n\n        DashInstance.prototype.init = function() {\n            Log.debug('Initializing dash instance', this);\n\n            this.initDatePickers();\n            this.initSelect2();\n\n            if (this.editing) {\n                this.blockPreferencesModal = new PreferencesModal(this.getRoot().find('.dash-edit-preferences'),\n                    this.blockContextid, function () {\n                        // Preferences changed, go back to first page.\n                        this.currentPage = 0;\n                        this.refresh();\n                    }.bind(this));\n            }\n\n            this.getRoot().on('change', 'select, input', function (e) {\n                e.preventDefault();\n\n                Log.debug('Submitting filter form');\n                Log.debug(e);\n                Log.debug($(e.target).serializeArray());\n\n                // Filter results, go back to first page.\n                this.currentPage = 0;\n                this.refresh();\n            }.bind(this));\n\n            this.getBlockContentArea().on('click', '.page-link', function(e) {\n                e.preventDefault();\n                this.currentPage = $(e.target).data('page');\n                this.refresh();\n            }.bind(this));\n\n            this.getBlockContentArea().on('click', '.dash-sort', function(e) {\n                const $target = $(e.target);\n                this.sortField = $target.data('sort');\n\n                // Set sorting to asc by default.\n                if (!this.sortDirections.hasOwnProperty(this.sortField)) {\n                    this.sortDirections[this.sortField] = 'asc';\n                } else {\n                    // Toggle sort direction on field.\n                    this.sortDirections[this.sortField] = this.sortDirections[this.sortField] === 'asc' ? 'desc' : 'asc';\n                }\n                this.refresh();\n            }.bind(this));\n        };\n\n        /**\n         * Get the root element of this dash instance.\n         *\n         * @method getRoot\n         * @return {object} jQuery object\n         */\n        DashInstance.prototype.getRoot = function() {\n            return this.root;\n        };\n\n        /**\n         * Get the content element of this dash instance.\n         *\n         * @method getRoot\n         * @return {object} jQuery object\n         */\n        DashInstance.prototype.getBlockContentArea = function() {\n            return this.getRoot().find(this.BLOCK_CONTENT_SELECTOR);\n        };\n\n        /**\n         * Get filter form element.\n         *\n         * @returns {object} jQuery object\n         */\n        DashInstance.prototype.getFilterForm = function() {\n            return this.getRoot().find(this.FILTER_FORM_SELECTOR);\n        };\n\n        DashInstance.prototype.getBlockContent = function() {\n            let sortDirection = null;\n            if (this.sortField && this.sortDirections.hasOwnProperty(this.sortField)) {\n                sortDirection = this.sortDirections[this.sortField];\n            }\n\n            var request = {\n                methodname: 'block_dash_get_block_content',\n                args: {\n                    block_instance_id: this.blockInstanceId,\n                    filter_form_data: JSON.stringify(this.getFilterForm().serializeArray()),\n                    page: this.currentPage,\n                    sort_field: this.sortField,\n                    sort_direction: sortDirection\n                }\n            };\n\n            return Ajax.call([request])[0];\n        };\n\n        DashInstance.prototype.refresh = function() {\n            this.getBlockContentArea().css('opacity', 0.5);\n            this.getBlockContent()\n                .then(function(response) {\n                    this.getBlockContentArea().html(response.html);\n                    this.getBlockContentArea().css('opacity', 1);\n                    this.initDatePickers();\n                    this.initSelect2();\n                }.bind(this))\n                .catch(Notification.exception);\n        };\n\n        DashInstance.prototype.initDatePickers = function() {\n            this.getRoot().find('.datepicker').datepicker2({\n                autoclose: true,\n                format: \"dd/mm/yyyy\"\n            });\n        };\n\n        DashInstance.prototype.initSelect2 = function() {\n            this.getRoot().find('.select2').each(function(index, element) {\n                let placeholder = null;\n                if ($(element).find(\"option[value='-1']\")) {\n                    placeholder = {\n                        id: '-1', // the value of the option\n                        text: $(element).find(\"option[value='-1']\").text()\n                    };\n                }\n                $(element).select2({\n                    dropdownParent: this.getRoot(),\n                    allowClear: true,\n                    theme: 'bootstrap4',\n                    placeholder: placeholder\n                }).on('select2:unselecting', function() {\n                    $(this).data('unselecting', true);\n                }).on('select2:opening', function(e) {\n                    if ($(this).data('unselecting')) {\n                        $(this).removeData('unselecting');\n                        e.preventDefault();\n                    }\n                });\n            }.bind(this));\n        };\n\n        return DashInstance;\n    });"],"names":["define","$","Log","Ajax","Notification","ModalEvents","PreferencesModal","DashInstance","root","blockInstanceId","blockContextid","editing","currentPage","blockPreferencesModal","sortField","sortDirections","init","prototype","BLOCK_CONTENT_SELECTOR","FILTER_FORM_SELECTOR","debug","this","initDatePickers","initSelect2","getRoot","find","refresh","bind","on","e","preventDefault","target","serializeArray","getBlockContentArea","data","$target","hasOwnProperty","getFilterForm","getBlockContent","sortDirection","request","methodname","args","block_instance_id","filter_form_data","JSON","stringify","page","sort_field","sort_direction","call","css","then","response","html","catch","exception","datepicker2","autoclose","format","each","index","element","placeholder","id","text","select2","dropdownParent","allowClear","theme","removeData"],"mappings":"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"}