{"version":3,"sources":["../src/preferences_modal.js"],"names":["define","$","jqueryui","Str","ModalFactory","ModalEvents","Fragment","Ajax","Select2","Notification","PreferencesModal","selector","contextid","onCloseCallback","tab","init","prototype","modal","triggers","get_string","then","title","create","type","types","DEFAULT","body","getBody","bind","setLarge","getRoot","on","shown","setBody","submitFormAjax","hide","save","submitForm","bodyRendered","sortable","items","handle","axis","initSelect2","hidden","e","window","onbeforeunload","changeTab","target","data","formdata","params","jsonformdata","JSON","stringify","loadFragment","handleFormSubmissionResponse","formData","closeWhenDone","response","validationerrors","handleFormSubmissionFailure","preventDefault","invalid","merge","find","length","first","focus","serialize","call","methodname","args","done","fail","exception","getModal","submit","each","index","element","placeholder","id","text","select2","dropdownParent","parent","allowClear","theme","removeData"],"mappings":"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","sourcesContent":["/**\n * Add a create new group modal to the page.\n *\n * @module     core_group/newgroup\n * @class      PreferencesModal\n * @package    core_group\n * @copyright  2017 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'jqueryui', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/fragment', 'core/ajax', 'block_dash/select2', 'core/notification'],\n    function($, jqueryui, Str, ModalFactory, ModalEvents, Fragment, Ajax, Select2, Notification) {\n\n    /**\n     * Constructor\n     *\n     * @param {String} selector used to find triggers for the new group modal.\n     * @param {int} contextid\n     *\n     * Each call to init gets it's own instance of this class.\n     */\n    var PreferencesModal = function(selector, contextid, onCloseCallback) {\n        this.contextid = contextid;\n        this.onCloseCallback = onCloseCallback;\n        this.tab = \"\";\n        this.init(selector);\n    };\n\n    /**\n     * @var {Modal} modal\n     * @private\n     */\n    PreferencesModal.prototype.modal = null;\n\n    /**\n     * @var {int} contextid\n     * @private\n     */\n    PreferencesModal.prototype.contextid = -1;\n\n    /**\n     * Initialise the class.\n     *\n     * @param {String} selector used to find triggers for the new group modal.\n     * @private\n     * @return {Promise}\n     */\n    PreferencesModal.prototype.init = function(selector) {\n        var triggers = $(selector);\n        // Fetch the title string.\n        return Str.get_string('editpreferences', 'block_dash').then(function(title) {\n            // Create the modal.\n            return ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                title: title,\n                body: this.getBody()\n            }, triggers);\n        }.bind(this)).then(function(modal) {\n            // Keep a reference to the modal.\n            this.modal = modal;\n\n            // Forms are big, we want a big modal.\n            this.modal.setLarge();\n\n            // We want to reset the form every time it is opened.\n            this.modal.getRoot().on(ModalEvents.shown, function() {\n                this.modal.setBody(this.getBody());\n            }.bind(this));\n\n            this.modal.getRoot().on('change', '#id_config_preferences_layout', this.submitFormAjax.bind(this, false));\n\n            this.modal.getRoot().on('click', '[data-action=cancel]', (e) => {\n                this.modal.hide();\n            });\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            this.modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n            // We also catch the form submit event and use it to submit the form with ajax.\n            this.modal.getRoot().on('submit', 'form', this.submitFormAjax.bind(this, true));\n\n            this.modal.getRoot().on(ModalEvents.bodyRendered, function(e) {\n                $(\"#fgroup_id_available_fields .form-inline > fieldset > div\").sortable({\n                    items: \".form-check-inline.fitem\",\n                    handle: \".drag-handle\",\n                    axis: \"y\"\n                });\n\n                this.initSelect2();\n            }.bind(this));\n\n            this.modal.getRoot().on(ModalEvents.hidden, function(e) {\n                // Prevent \"changes may be lost\" popup.\n                window.onbeforeunload = null;\n                if (this.onCloseCallback) {\n                    this.onCloseCallback(e);\n                }\n            }.bind(this));\n\n            this.modal.getRoot().on('click', '[data-action=change-tab]', (e) => {\n                this.changeTab($(e.target).data('tab'));\n            });\n\n            return this.modal;\n        }.bind(this));\n    };\n\n    PreferencesModal.prototype.changeTab = function(tab) {\n        this.tab = tab;\n        this.submitFormAjax(false);\n    };\n\n    /**\n     * @method getBody\n     * @private\n     * @return {Promise}\n     */\n    PreferencesModal.prototype.getBody = function(formdata) {\n        if (typeof formdata === \"undefined\") {\n            formdata = {};\n        }\n\n        // Get the content of the modal.\n        var params = {\n            jsonformdata: JSON.stringify(formdata),\n            tab: this.tab\n        };\n        return Fragment.loadFragment('block_dash', 'block_preferences_form', this.contextid, params);\n    };\n\n    /**\n     * @method handleFormSubmissionResponse\n     * @private\n     * @return {Promise}\n     */\n    PreferencesModal.prototype.handleFormSubmissionResponse = function(formData, closeWhenDone, response) {\n        if (response.validationerrors || !closeWhenDone) {\n            this.modal.setBody(this.getBody(formData));\n        } else if (closeWhenDone) {\n            this.modal.hide();\n        }\n    };\n\n    /**\n     * @method handleFormSubmissionFailure\n     * @private\n     * @return {Promise}\n     */\n    PreferencesModal.prototype.handleFormSubmissionFailure = function(data) {\n        // Oh noes! Epic fail :(\n        // Ah wait - this is normal. We need to re-display the form with errors!\n        this.modal.setBody(this.getBody(data));\n    };\n\n    /**\n     * Private method\n     *\n     * @method submitFormAjax\n     * @private\n     * @param {Event} e Form submission event.\n     * @param {boolean} closeWhenDone If true modal will close after successful submission.\n     */\n    PreferencesModal.prototype.submitFormAjax = function(closeWhenDone, e) {\n        // We don't want to do a real form submission.\n        if (e) {\n            e.preventDefault();\n        }\n\n        // Now the change events have run, see if there are any \"invalid\" form fields.\n        var invalid = $.merge(\n            this.modal.getRoot().find('[aria-invalid=\"true\"]'),\n            this.modal.getRoot().find('.error')\n        );\n\n        // If we found invalid fields, focus on the first one and do not submit via ajax.\n        if (invalid.length) {\n            invalid.first().focus();\n            return;\n        }\n\n        // Convert all the form elements values to a serialised string.\n        var formData = this.modal.getRoot().find('form').serialize();\n\n        // Now we can continue...\n        Ajax.call([{\n            methodname: 'block_dash_submit_preferences_form',\n            args: {\n                contextid: this.contextid,\n                jsonformdata: JSON.stringify(formData)\n            },\n            done: this.handleFormSubmissionResponse.bind(this, formData, closeWhenDone),\n            fail: this.handleFormSubmissionFailure.bind(this, formData)\n        }])[0].fail(Notification.exception);\n    };\n\n    PreferencesModal.prototype.getModal = function() {\n        return this.modal;\n    };\n\n    /**\n     * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n     *\n     * @method submitForm\n     * @param {Event} e Form submission event.\n     * @private\n     */\n    PreferencesModal.prototype.submitForm = function(e) {\n        e.preventDefault();\n        this.modal.getRoot().find('form').submit();\n    };\n\n    PreferencesModal.prototype.initSelect2 = function() {\n        var self = this;\n        this.modal.getRoot().find('.select2-form select').each(function(index, element) {\n            let placeholder = null;\n            if ($(element).find(\"option[value='-1']\")) {\n                placeholder = {\n                    id: '-1', // the value of the option\n                    text: $(element).find(\"option[value='-1']\").text()\n                };\n            }\n            $(element).select2({\n                dropdownParent: $(this).parent(),\n                allowClear: true,\n                theme: 'bootstrap4',\n                placeholder: placeholder\n            }).on('select2:unselecting', function() {\n                $(this).data('unselecting', true);\n            }).on('select2:opening', function(e) {\n                if ($(this).data('unselecting')) {\n                    $(this).removeData('unselecting');\n                    e.preventDefault();\n                }\n            });\n        });\n    };\n\n    return PreferencesModal;\n});\n"],"file":"preferences_modal.min.js"}